name: build

on:
  push:
  pull_request:
  workflow_dispatch:

env:
  CMAKE_BUILD_TYPE: Release
  MI_SERVER_PUB_HEX: ${{ secrets.MI_SERVER_PUB_HEX }}
  MI_SERVER_SIGN_PUB_HEX: ${{ secrets.MI_SERVER_SIGN_PUB_HEX }}
  MI_SERVER_SIGN_PRIV_HEX: ${{ secrets.MI_SERVER_SIGN_PRIV_HEX }}
  MI_DEFAULT_IP: 127.0.0.1
  MI_DEFAULT_PORT: 19999

jobs:
  cmake:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest]
    steps:
      - uses: actions/checkout@v4

      - name: Install deps (Ubuntu)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake libssl-dev libmysqlclient-dev git
          # build ikcp from source
          git clone https://github.com/skywind3000/kcp.git /tmp/kcp
          pushd /tmp/kcp && mkdir -p build && cd build && cmake .. && cmake --build . --config Release && sudo cmake --install . && popd

      - name: Install deps (Windows)
        if: runner.os == 'Windows'
        run: |
          $ErrorActionPreference = 'Continue'
          choco install openssl --no-progress -y || echo "openssl install skipped"
          choco install vcredist140 --no-progress -y || echo "vcredist install skipped"
          echo "OPENSSL_ROOT_DIR=C:\Program Files\OpenSSL-Win64" >> $env:GITHUB_ENV
          echo "OPENSSL_DIR=C:\Program Files\OpenSSL-Win64" >> $env:GITHUB_ENV
          echo "OPENSSL_LIB_DIR=C:\Program Files\OpenSSL-Win64\lib" >> $env:GITHUB_ENV
          choco install mysql-connector-c --no-progress -y || echo "mysql connector install skipped"
          choco install cmake --installargs 'ADD_CMAKE_TO_PATH=System' --no-progress -y || echo "cmake already present"
          choco install mysql --no-progress -y || echo "mysql install skipped"

      - name: Generate self-signed cert (PEM, base64)
        shell: bash
        run: |
          if [ "$RUNNER_OS" = "Windows" ]; then
            export PATH="/c/Program Files/OpenSSL-Win64/bin:$PATH"
            export MSYS2_ARG_CONV_EXCL="*"
          fi
          openssl req -x509 -newkey rsa:2048 -sha256 -days 365 -nodes \
            -subj "/CN=mi-e2ee/O=MI/OU=CI" \
            -keyout cert.key -out cert.pem
          python - <<'PY' > cert.env
          import base64, pathlib
          pem = pathlib.Path("cert.pem").read_bytes()
          key = pathlib.Path("cert.key").read_bytes()
          print(f"MI_CERT_PEM_B64={base64.b64encode(pem).decode()}")
          print(f"MI_CERT_KEY_PEM_B64={base64.b64encode(key).decode()}")
          PY
          cat cert.env >> "$GITHUB_ENV"

      - name: Bootstrap server keys when secrets are empty
        shell: bash
        run: |
          python - <<'PY' > keys.env
          import os, secrets, pathlib
          names = ["MI_SERVER_PUB_HEX", "MI_SERVER_SIGN_PUB_HEX", "MI_SERVER_SIGN_PRIV_HEX"]
          env = {}
          for n in names:
              v = os.environ.get(n, "").strip()
              if not v:
                  v = secrets.token_hex(32)
              env[n] = v
          pathlib.Path("keys.env").write_text("".join(f"{k}={v}\n" for k,v in env.items()), encoding="utf-8")
          PY
          cat keys.env >> "$GITHUB_ENV"

      - name: Configure
        shell: bash
        run: |
          cmake -S . -B build -DCMAKE_BUILD_TYPE=${{ env.CMAKE_BUILD_TYPE }} \
            -DMI_USE_OPENSSL=ON -DMI_USE_KCP=ON -DMI_USE_MYSQL=ON \
            -DMI_SERVER_PUB_HEX=${{ env.MI_SERVER_PUB_HEX }} \
            -DMI_SERVER_SIGN_PUB_HEX=${{ env.MI_SERVER_SIGN_PUB_HEX }} \
            -DMI_SERVER_SIGN_PRIV_HEX=${{ env.MI_SERVER_SIGN_PRIV_HEX }} \
            -DMI_CERT_PEM_B64=${{ env.MI_CERT_PEM_B64 }} \
            -DMI_CERT_KEY_PEM_B64=${{ env.MI_CERT_KEY_PEM_B64 }} \
            -DMI_REQUIRE_KEYS=ON

      - name: Build
        run: cmake --build build --config ${{ env.CMAKE_BUILD_TYPE }} --target mi_server_app mi_client_e2ee
        shell: bash

      - name: List built client libs (debug info)
        if: runner.os == 'Windows'
        run: |
          Get-ChildItem -Recurse build\mi_client_E2EE -Include *.lib
        shell: pwsh

      - name: Copy client lib for node-gyp (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path mi_client_E2EE/mi_bridge/build/Release | Out-Null
          Copy-Item build/mi_client_E2EE/Release/mi_client_e2ee.lib mi_client_E2EE/mi_bridge/build/Release/ -Force
          Copy-Item build/Release/mi_internal.lib mi_client_E2EE/mi_bridge/build/Release/ -Force

      - name: Build Node addon (mi_bridge, Linux)
        if: runner.os != 'Windows'
        working-directory: mi_client_E2EE/mi_bridge
        shell: bash
        run: |
          npm install --no-fund --no-audit
          npx node-gyp rebuild --target=28.0.0 --dist-url=https://electronjs.org/headers

      - name: Build Node addon (mi_bridge, Windows)
        if: runner.os == 'Windows'
        working-directory: mi_client_E2EE/mi_bridge
        shell: cmd
        run: |
          set npm_config_msvs_version=2022
          set GYP_MSVS_VERSION=2022
          set OPENSSL_DIR=C:\Program Files\OpenSSL-Win64
          set OPENSSL_ROOT_DIR=C:\Program Files\OpenSSL-Win64
          set OPENSSL_LIB_DIR=C:\Program Files\OpenSSL-Win64\lib
          set INCLUDE=C:\Program Files\OpenSSL-Win64\include;%INCLUDE%
          set LIB=C:\Program Files\OpenSSL-Win64\lib;C:\Program Files\OpenSSL-Win64\lib\VC;%LIB%
          powershell -NoProfile -Command ^
            " $ErrorActionPreference = 'SilentlyContinue';" ^
            " $roots = @('C:\\Program Files\\OpenSSL-Win64\\lib','C:\\Program Files\\OpenSSL-Win64','C:\\Program Files','C:\\Program Files (x86)');" ^
            " $ssl = $null; foreach($r in $roots){ $c = Get-ChildItem -Path $r -Recurse -Filter 'libssl*.lib' -File | Select-Object -First 1; if($c){ $ssl = $c; break } };" ^
            " if(-not $ssl){ Write-Error 'libssl*.lib not found in OpenSSL install'; exit 1 };" ^
            " Copy-Item $ssl.FullName 'libssl.lib' -Force;"
          powershell -NoProfile -Command ^
            " $ErrorActionPreference = 'SilentlyContinue';" ^
            " $roots = @('C:\\Program Files\\OpenSSL-Win64\\lib','C:\\Program Files\\OpenSSL-Win64','C:\\Program Files','C:\\Program Files (x86)');" ^
            " $crypto = $null; foreach($r in $roots){ $c = Get-ChildItem -Path $r -Recurse -Filter 'libcrypto*.lib' -File | Select-Object -First 1; if($c){ $crypto = $c; break } };" ^
            " if(-not $crypto){ Write-Error 'libcrypto*.lib not found in OpenSSL install'; exit 1 };" ^
            " Copy-Item $crypto.FullName 'libcrypto.lib' -Force;"
          for /f "usebackq delims=" %%i in (`"C:\Program Files (x86)\Microsoft Visual Studio\Installer\vswhere.exe" -latest -products * -requires Microsoft.VisualStudio.Component.VC.Tools.x86.x64 -property installationPath`) do set VSPATH=%%i
          if "%VSPATH%"=="" (echo VS install not found & exit /b 1)
          call "%VSPATH%\VC\Auxiliary\Build\vcvars64.bat"
          call npm install --no-fund --no-audit
          call npx node-gyp rebuild --release --msvs_version=2022 --target=28.0.0 --dist-url=https://electronjs.org/headers --openssl_root="C:\Program Files\OpenSSL-Win64" --openssl_dir="C:\Program Files\OpenSSL-Win64" --openssl_libpath="C:\Program Files\OpenSSL-Win64\lib"

      - name: Copy mi_bridge addon into Electron app (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path mi_client_E2EE/src/E2EE_Client_Windows/mi_bridge/build/Release | Out-Null
          Copy-Item mi_client_E2EE/mi_bridge/build/Release/mi_bridge.node mi_client_E2EE/src/E2EE_Client_Windows/mi_bridge/build/Release/ -Force

      - name: Build Electron client (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        working-directory: mi_client_E2EE/src/E2EE_Client_Windows
        run: |
          npm install --no-fund --no-audit
          npm run build
          New-Item -ItemType Directory -Force -Path ..\..\..\dist | Out-Null

      - name: Inject mi_bridge.node into win-unpacked (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $nodePath = "mi_client_E2EE/mi_bridge/build/Release/mi_bridge.node"
          if (-Not (Test-Path $nodePath)) { Write-Host "mi_bridge.node not found at $nodePath"; exit 1 }
          $unpacked = Get-ChildItem mi_client_E2EE/src/E2EE_Client_Windows/dist -Directory -Filter "*win-unpacked*" | Select-Object -First 1
          if (-Not $unpacked) { Write-Host "win-unpacked not found after build"; exit 1 }
          $dst1 = Join-Path $unpacked.FullName "resources/app.asar.unpacked/mi_bridge/build/Release"
          $dst2 = Join-Path $unpacked.FullName "resources/app/mi_bridge/build/Release"
          New-Item -ItemType Directory -Force -Path $dst1,$dst2 | Out-Null
          Copy-Item $nodePath $dst1 -Force
          Copy-Item $nodePath $dst2 -Force

      - name: Bundle runtime deps into Electron app (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path dist | Out-Null
          $unpacked = Get-ChildItem mi_client_E2EE/src/E2EE_Client_Windows/dist -Directory -Filter "*win-unpacked*" | Select-Object -First 1
          if (-Not $unpacked) { Write-Error "win-unpacked not found after build"; exit 1 }
          $targets = @(
            Join-Path $unpacked.FullName "resources/app.asar.unpacked/mi_bridge/build/Release",
            Join-Path $unpacked.FullName "resources/app/mi_bridge/build/Release"
          )
          New-Item -ItemType Directory -Force -Path $targets | Out-Null
          $dlls = @()
          $ssl = Get-ChildItem "C:\Program Files" -Recurse -ErrorAction SilentlyContinue -Include "libssl-*-x64.dll","libssl-3*.dll","libssl-1_1-x64.dll" | Select-Object -First 1
          $crypto = Get-ChildItem "C:\Program Files" -Recurse -ErrorAction SilentlyContinue -Include "libcrypto-*-x64.dll","libcrypto-3*.dll","libcrypto-1_1-x64.dll" | Select-Object -First 1
          $mysql = Get-ChildItem "C:\Program Files" -Recurse -ErrorAction SilentlyContinue -Include "libmysql.dll" | Select-Object -First 1
          $vc = Get-ChildItem "C:\Windows\System32" -ErrorAction SilentlyContinue -Include "vcruntime140*.dll","msvcp140*.dll" | Select-Object -First 3
          if (-not $ssl -or -not $crypto) { Write-Error "OpenSSL runtime dlls not found"; exit 1 }
          $dlls += @($ssl, $crypto)
          if ($mysql) { $dlls += $mysql }
          if ($vc) { $dlls += $vc }
          foreach ($target in $targets) {
            foreach ($dll in $dlls) {
              Copy-Item $dll.FullName $target -Force
            }
          }
          $zipDir = (Resolve-Path dist).Path
          $zipPath = Join-Path $zipDir "client-electron-windows.zip"
          if (Test-Path $zipPath) { Remove-Item $zipPath -Force }
          $distRoot = (Resolve-Path mi_client_E2EE/src/E2EE_Client_Windows/dist).Path
          Compress-Archive -Path "$distRoot\*" -DestinationPath $zipPath -Force

      - name: Package artifacts (Linux)
        if: runner.os == 'Linux'
        shell: bash
        env:
          ART_OS: ${{ matrix.os }}
        run: |
          mkdir -p dist/server dist/client
          find build -type f \( -name "mi_server_app" -o -name "libmi_server.a" -o -name "mi_server_app*" \) -exec cp {} dist/server/ \; || true
          find build -type f \( -name "libmi_client_e2ee.a" -o -name "mi_client_e2ee.a" -o -name "libmi_client_e2ee.so" \) -exec cp {} dist/client/ \; || true
          if ls dist/server/* >/dev/null 2>&1; then zip -jr "server-${ART_OS}.zip" dist/server/*; else echo "no server artifacts"; fi
          if ls dist/client/* >/dev/null 2>&1; then zip -jr "client-${ART_OS}.zip" dist/client/*; else echo "no client artifacts"; fi

      - name: Package artifacts (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        env:
          ART_OS: ${{ matrix.os }}
        run: |
          New-Item -ItemType Directory -Force -Path dist/server,dist/client | Out-Null
          Get-ChildItem build -Recurse -Include mi_server_app.exe,mi_server.lib,libmi_server.a | ForEach-Object { Copy-Item $_.FullName dist/server -Force }
          Get-ChildItem build -Recurse -Include mi_client_e2ee.lib,libmi_client_e2ee.a | ForEach-Object { Copy-Item $_.FullName dist/client -Force }
          # 拷贝运行时 DLL（OpenSSL + MySQL），兜底搜 Program Files
          $dlls = @()
          $crypto = Get-ChildItem "C:\Program Files" -Recurse -ErrorAction SilentlyContinue -Include "libcrypto-*-x64.dll","libcrypto-*.dll" | Select-Object -First 1
          $ssl    = Get-ChildItem "C:\Program Files" -Recurse -ErrorAction SilentlyContinue -Include "libssl-*-x64.dll","libssl-*.dll" | Select-Object -First 1
          $mysqlDll = Get-ChildItem "C:\Program Files" -Recurse -ErrorAction SilentlyContinue -Include "libmysql.dll" | Select-Object -First 1
          if ($crypto) { $dlls += $crypto.FullName }
          if ($ssl)    { $dlls += $ssl.FullName }
          if ($mysqlDll) { $dlls += $mysqlDll.FullName }
          # VS 运行时（vcruntime/msvcp）
          $vcDlls = Get-ChildItem "C:\Windows\System32" -ErrorAction SilentlyContinue -Include "vcruntime140*.dll","msvcp140*.dll" | Select-Object -First 3
          if ($vcDlls) { $dlls += $vcDlls.FullName }
          if ($dlls.Count -gt 0) { Copy-Item $dlls dist/server -Force } else { Write-Host "runtime dlls not found"; }
          if (Test-Path dist/server\*) { Compress-Archive -Path dist/server\* -DestinationPath ("server-" + $env:ART_OS + ".zip") -Force } else { Write-Host "no server artifacts"; }
          if (Test-Path dist/client\*) { Compress-Archive -Path dist/client\* -DestinationPath ("client-" + $env:ART_OS + ".zip") -Force } else { Write-Host "no client artifacts"; }

      - name: Upload server artifact
        uses: actions/upload-artifact@v4
        with:
          name: server-${{ matrix.os }}
          path: server-${{ matrix.os }}.zip
        if: always()

      - name: Upload client artifact
        uses: actions/upload-artifact@v4
        with:
          name: client-${{ matrix.os }}
          path: client-${{ matrix.os }}.zip
        if: always()

      - name: Upload electron client (Windows)
        if: runner.os == 'Windows'
        uses: actions/upload-artifact@v4
        with:
          name: client-electron-windows
          path: dist/client-electron-windows.zip
