name: build

on:
  push:
  pull_request:
  workflow_dispatch:

env:
  CMAKE_BUILD_TYPE: Release
  MI_SERVER_PUB_HEX: ${{ secrets.MI_SERVER_PUB_HEX }}
  MI_SERVER_SIGN_PUB_HEX: ${{ secrets.MI_SERVER_SIGN_PUB_HEX }}
  MI_SERVER_SIGN_PRIV_HEX: ${{ secrets.MI_SERVER_SIGN_PRIV_HEX }}
  MI_DEFAULT_IP: 127.0.0.1
  MI_DEFAULT_PORT: 19999

jobs:
  cmake:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest]
    steps:
      - uses: actions/checkout@v4

      - name: Install deps (Ubuntu)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake libssl-dev libmysqlclient-dev git
          # build ikcp from source
          git clone https://github.com/skywind3000/kcp.git /tmp/kcp
          pushd /tmp/kcp && mkdir -p build && cd build && cmake .. && cmake --build . --config Release && sudo cmake --install . && popd

      - name: Install deps (Windows)
        if: runner.os == 'Windows'
        run: |
          $ErrorActionPreference = 'Continue'
          choco install openssl --no-progress -y || echo "openssl install skipped"
          choco install cmake --installargs 'ADD_CMAKE_TO_PATH=System' --no-progress -y || echo "cmake already present"
          echo "mysql client skipped on Windows (stub mode)"

      - name: Generate self-signed cert (PEM, base64)
        shell: bash
        run: |
          if [ "$RUNNER_OS" = "Windows" ]; then
            export PATH="/c/Program Files/OpenSSL-Win64/bin:$PATH"
            export MSYS2_ARG_CONV_EXCL="*"
          fi
          openssl req -x509 -newkey rsa:2048 -sha256 -days 365 -nodes \
            -subj "/CN=mi-e2ee/O=MI/OU=CI" \
            -keyout cert.key -out cert.pem
          python - <<'PY' > cert.env
          import base64, pathlib
          pem = pathlib.Path("cert.pem").read_bytes()
          key = pathlib.Path("cert.key").read_bytes()
          print(f"MI_CERT_PEM_B64={base64.b64encode(pem).decode()}")
          print(f"MI_CERT_KEY_PEM_B64={base64.b64encode(key).decode()}")
          PY
          cat cert.env >> "$GITHUB_ENV"

      - name: Bootstrap server keys when secrets are empty
        shell: bash
        run: |
          python - <<'PY' > keys.env
          import os, secrets, pathlib
          names = ["MI_SERVER_PUB_HEX", "MI_SERVER_SIGN_PUB_HEX", "MI_SERVER_SIGN_PRIV_HEX"]
          env = {}
          for n in names:
              v = os.environ.get(n, "").strip()
              if not v:
                  v = secrets.token_hex(32)
              env[n] = v
          pathlib.Path("keys.env").write_text("".join(f"{k}={v}\n" for k,v in env.items()), encoding="utf-8")
          PY
          cat keys.env >> "$GITHUB_ENV"

      - name: Configure
        shell: bash
        run: |
          cmake -S . -B build -DCMAKE_BUILD_TYPE=${{ env.CMAKE_BUILD_TYPE }} \
            -DMI_USE_OPENSSL=ON -DMI_USE_KCP=ON -DMI_USE_MYSQL=ON \
            -DMI_SERVER_PUB_HEX=${{ env.MI_SERVER_PUB_HEX }} \
            -DMI_SERVER_SIGN_PUB_HEX=${{ env.MI_SERVER_SIGN_PUB_HEX }} \
            -DMI_SERVER_SIGN_PRIV_HEX=${{ env.MI_SERVER_SIGN_PRIV_HEX }} \
            -DMI_CERT_PEM_B64=${{ env.MI_CERT_PEM_B64 }} \
            -DMI_CERT_KEY_PEM_B64=${{ env.MI_CERT_KEY_PEM_B64 }} \
            -DMI_REQUIRE_KEYS=ON

      - name: Build
        run: cmake --build build --config ${{ env.CMAKE_BUILD_TYPE }} --target mi_server_app mi_client_e2ee
        shell: bash

      - name: Build Electron client (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        working-directory: mi_client_E2EE/src/E2EE_Client_Windows
        run: |
          npm install --no-fund --no-audit
          npm run build
          New-Item -ItemType Directory -Force -Path ..\..\..\dist | Out-Null
          if (Test-Path dist) {
            Compress-Archive -Path dist\* -DestinationPath ..\..\..\dist\client-electron-windows.zip -Force
          }

      - name: Package artifacts (Linux)
        if: runner.os == 'Linux'
        shell: bash
        env:
          ART_OS: ${{ matrix.os }}
        run: |
          mkdir -p dist/server dist/client
          find build -type f \( -name "mi_server_app" -o -name "libmi_server.a" -o -name "mi_server_app*" \) -exec cp {} dist/server/ \; || true
          find build -type f \( -name "libmi_client_e2ee.a" -o -name "mi_client_e2ee.a" -o -name "libmi_client_e2ee.so" \) -exec cp {} dist/client/ \; || true
          if ls dist/server/* >/dev/null 2>&1; then zip -jr "server-${ART_OS}.zip" dist/server/*; else echo "no server artifacts"; fi
          if ls dist/client/* >/dev/null 2>&1; then zip -jr "client-${ART_OS}.zip" dist/client/*; else echo "no client artifacts"; fi

      - name: Package artifacts (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        env:
          ART_OS: ${{ matrix.os }}
        run: |
          New-Item -ItemType Directory -Force -Path dist/server,dist/client | Out-Null
          Get-ChildItem build -Recurse -Include mi_server_app.exe,mi_server.lib,libmi_server.a | ForEach-Object { Copy-Item $_.FullName dist/server -Force }
          Get-ChildItem build -Recurse -Include mi_client_e2ee.lib,libmi_client_e2ee.a | ForEach-Object { Copy-Item $_.FullName dist/client -Force }
          if (Test-Path dist/server\*) { Compress-Archive -Path dist/server\* -DestinationPath ("server-" + $env:ART_OS + ".zip") -Force } else { Write-Host "no server artifacts"; }
          if (Test-Path dist/client\*) { Compress-Archive -Path dist/client\* -DestinationPath ("client-" + $env:ART_OS + ".zip") -Force } else { Write-Host "no client artifacts"; }

      - name: Upload server artifact
        uses: actions/upload-artifact@v4
        with:
          name: server-${{ matrix.os }}
          path: server-${{ matrix.os }}.zip
        if: always()

      - name: Upload client artifact
        uses: actions/upload-artifact@v4
        with:
          name: client-${{ matrix.os }}
          path: client-${{ matrix.os }}.zip
        if: always()

      - name: Upload electron client (Windows)
        if: runner.os == 'Windows'
        uses: actions/upload-artifact@v4
        with:
          name: client-electron-windows
          path: dist/client-electron-windows.zip
