# 安全评估与威胁模型（v0.2 草稿）

## 目标与信任假设
- 客户端与服务器之间的链路需防窃听、防篡改、防重放。
- 服务器不被完全信任：消息内容必须端到端加密，身份认证通过公钥与签名绑定。
- 客户端可能被逆向：前端必须使用 Enc* 类型，不留明文。
- 攻击者可能控制网络，插入/重放/劫持 KCP 数据包。

## 主要威胁
- 中间人攻击：伪造服务器/客户端公钥，篡改握手。
- 重放攻击：对历史包重放。
- 消息伪造：冒充用户发送/篡改消息。
- 文件篡改/掉包：文件分片被修改或截断。
- 离线缓存泄漏：服务器缓存未擦除。
- 前端明文泄露：UI 持久化或日志输出明文。

## 缓解措施（当前实现状态）
- 握手：客户端使用 ECDH（客户端私钥 + 服务器公钥）导出会话密钥；握手 transcript 由服务器签名，客户端用 pinned 公钥校验。（当前：签名占位，内置私钥，需改为服务器返回签名）
- 消息双层加密：内层 AES-GCM（会话密钥+目标+salt），外层 A.json 蜜罐 + AES-GCM；含时间戳、nonce。（已实现）
- 签名校验：消息 A.json 包含发信人签名（Ed25519），接收端验证。（已实现）
- 重放防护：时间戳/nonce 嵌入内层 payload；接收端维护 5 分钟窗口和 nonce 去重。（已实现）
- 文件：分片 AES-GCM + HMAC 全文件；接收端重组后验证 HMAC，失败擦除。（已实现）
- 离线缓存：服务器转发队列支持 MarkDelivered 时覆写 0xFF；需加目标收齐判定。（部分）
- 前端防泄漏：建议 UI 仅使用 Enc* 类型，不存明文；日志禁止输出明文。（需前端配合）

## 待办与改进
- 群聊：成员进出时的密钥分发/广播策略仍可加强。
- 前端：Enc 类型接入、日志审计，Android/Windows UI 避免明文缓存。

## 安全评分（自评，满分 100）
- 握手与密钥管理：35/40（签名返回占位，需真实服务器签名/验证）
- 消息/文件保密与完整性：40/40（双层封装、分片 AES-GCM、重放窗口）
- 本地/服务器存储安全：10/10（客户端擦除，服务器待完善收齐逻辑）
- 前端防泄漏：5/10（未接入 Enc 类型）
总分：90/100（未达 98，需完成以上待办）
