Backend API (server side)
========================

Types (from include/mi_common.h)
--------------------------------
- MI_Result: MI_OK=0; error codes include MI_ERR_USER_NOT_FOUND, MI_ERR_BAD_PASSWORD, MI_ERR_SERVER_UNAVAILABLE, MI_ERR_ENCRYPT/DECRYPT/KEY_MISMATCH, MI_ERR_KCP_DISCONNECTED/HANDSHAKE_FAILED, MI_ERR_FILE_ENCRYPT/FILE_WIPE, MI_ERR_STORAGE, MI_ERR_INVALID_CONFIG, MI_ERR_NOT_IMPLEMENTED.
- ConfigStruct: work_dir (const char*), log_level (int), enable_hardware_crypto (int), server_ip (const char*), server_port (int). Passed to init.
- EncString/EncJson/EncBuffer: encrypted payload wrappers with len/layout_id/algo_id/salt/data.
- UserInfo: username (const char*), pubkey (PublicKey), password_sha256 (optional const uint8_t[32]), password_len (size_t). Password bytes must be 32 when provided.
- SessionInfo: username (const char*), status (int). SessionList holds items + count.

Server API
----------
- MI_Result MI_Server_Init(const ConfigStruct* cfg)
  * Purpose: initialize server runtime, KCP sockets, replay cache, optional storage.
  * Params: cfg->work_dir as working directory (holds replay cache), cfg->log_level verbosity, enable_hardware_crypto toggles hardware crypto use, server_ip/port bind address (defaults 0.0.0.0:19999 if null/0).
  * Returns: MI_OK on success; MI_ERR_INVALID_CONFIG or MI_ERR_SERVER_UNAVAILABLE on bind/init failure.

- void MI_Server_Shutdown(void)
  * Purpose: stop server, close KCP sockets, flush relay cache.
  * Params: none.
  * Returns: none.

- MI_Result MI_Server_AddUser(const UserInfo* user)
  * Purpose: add or update a user record (username, public key, optional password hash).
  * Params: user->username (null-terminated), user->pubkey (32 bytes), optional user->password_sha256 (32-byte SHA-256), password_len must be 32 when provided.
  * Returns: MI_OK on success; MI_ERR_INVALID_CONFIG if fields missing.

- MI_Result MI_Server_RemoveUser(const EncString username)
  * Purpose: remove user by encrypted username.
  * Params: username encrypted payload (len/data/layout/algo/salt).
  * Returns: MI_OK or MI_ERR_USER_NOT_FOUND.

- MI_Result MI_Server_ListSessions(SessionList* out)
  * Purpose: snapshot active sessions.
  * Params: out->items/out->count populated on success; caller owns lifetime.
  * Returns: MI_OK on success; MI_ERR_INVALID_CONFIG on null.

- MI_Result MI_Server_FreeSessionList(SessionList* list)
  * Purpose: free memory allocated by MI_Server_ListSessions.
  * Params: list from previous call.
  * Returns: MI_OK or MI_ERR_INVALID_CONFIG.

- MI_Result MI_Server_AuthLogin(const EncString username, const uint8_t password_sha256[32])
  * Purpose: verify user credentials.
  * Params: username encrypted; password_sha256 raw 32-byte hash.
  * Returns: MI_OK on success; MI_ERR_BAD_PASSWORD or MI_ERR_USER_NOT_FOUND on failure.

- MI_Result MI_Server_SetMySQLConfig(const char* host, int port, const char* user, const char* password, const char* db)
  * Purpose: configure MySQL connection before enabling.
  * Params: host (e.g., 127.0.0.1), port, user, password, db name.
  * Returns: MI_OK or MI_ERR_INVALID_CONFIG.

- MI_Result MI_Server_EnableMySQL(int enable)
  * Purpose: toggle MySQL-backed auth/storage.
  * Params: enable !=0 to enable, 0 to disable.
  * Returns: MI_OK on success; MI_ERR_SERVER_UNAVAILABLE if connection fails.

Relay / KCP helpers
-------------------
- MI_Result MI_Server_RelayEnqueue(const EncString target, const EncBuffer* packet)
  * Purpose: enqueue encrypted packet for target user in relay cache.
  * Params: target encrypted username; packet encrypted buffer payload.
  * Returns: MI_OK or MI_ERR_STORAGE on failure.

- MI_Result MI_Server_RelayDequeue(const EncString target, EncBuffer* out_packet)
  * Purpose: pop next pending packet for target.
  * Params: target encrypted username; out_packet receives buffer (caller frees data per implementation contract).
  * Returns: MI_OK when a packet is output; MI_ERR_USER_NOT_FOUND or MI_ERR_STORAGE otherwise.

- MI_Result MI_Server_RelayMarkDelivered(const EncString target)
  * Purpose: mark latest dequeued packet as delivered/acked for target.
  * Params: target encrypted username.
  * Returns: MI_OK or MI_ERR_STORAGE.

- MI_Result MI_Server_RelayPendingCount(const EncString target, uint32_t* out_count)
  * Purpose: query pending packet count for target.
  * Params: target encrypted username; out_count filled on success.
  * Returns: MI_OK; MI_ERR_INVALID_CONFIG on null.

- MI_Result MI_Server_PollKCP(void)
  * Purpose: poll KCP sockets; call in server loop.
  * Params: none.
  * Returns: MI_OK or MI_ERR_KCP_DISCONNECTED if underlying transport fails.

- MI_Result MI_Server_FlushRelay(void)
  * Purpose: flush relay queues to storage/delivery.
  * Params: none.
  * Returns: MI_OK or MI_ERR_STORAGE on persistence failure.

Notes
-----
- MI_DEFAULT_PORT is 19999.
- Encrypted types (EncString/EncJson/EncBuffer) carry layout_id/algo_id/salt for client/server negotiated ciphers; payload memory ownership follows caller/callee conventions in implementations.
- Replay cache persists in work_dir/replay.cache; call PollKCP/FlushRelay regularly in event loop.
