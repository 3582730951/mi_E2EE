========================================
EncryptedBasicTypes.md —— 加密基础类型设计文档
版本：v1.0
说明：Codex 输出给前端的说明文档，指导前端正确使用加密类型。
========================================

# 目录
1. 设计目标
2. 威胁模型
3. 基础加密类型总览
4. 内存布局与跨平台一致性
5. 类型恢复流程（解密）
6. 类型转换流程（printf/前端传参时）
7. 与 UI 的交互约束（Gemini 必读）
8. 类型的 DLL/SO 接口说明
9. 示例代码（C / C++ / 前端绑定）
10. 性能影响与优化策略
11. 安全注意事项

----------------------------------------
# 1. 设计目标
----------------------------------------
- 防止客户端被 IDA / Ghidra 静态分析  
- 防止内存取值被直接还原  
- 类型必须跨 Windows / Linux / Android 可用  
- 必须对前端透明（可通过接口访问）

----------------------------------------
# 2. 威胁模型
----------------------------------------
攻击者可能：
- 反编译客户端  
- 截获进程内存  
- 替换 DLL/SO  
- Hook 系统 API  

加密类型必须在此威胁模型下仍然保持安全。

----------------------------------------
# 3. 基础加密类型总览
----------------------------------------
EncInt  
EncLong  
EncString  
EncJson  
EncBuffer  

每种类型包含：
- 随机化内存布局  
- 加密方式标记字节（3~4 字节）  
- 时间种子混淆  
- 字节打乱顺序（16 种排列之一）

----------------------------------------
# 4. 内存布局（核心）
----------------------------------------
以 EncInt 为例：
原始数据（4 字节）: [A][B][C][D]

加密布局：
随机打乱：16 种排列之一
+ 加密方式编号（1 byte）
+ 随机盐（2~3 byte）
最终：
total = 7~8 bytes

对每种类型必须描述：

- 加密布局  
- 对齐（alignment）策略  
- 内存跨度（跨平台一致）  

----------------------------------------
# 5. 类型恢复流程
----------------------------------------
EncInt → 解密 → 普通 int  
EncString → 解密 → UTF-8 字符串  

只能通过 DLL/SO 提供的接口恢复。

----------------------------------------
# 6. 前端传参流程（必须）
----------------------------------------
UI 输入的普通数据 →  
调用 DLL/SO 进行加密 →  
获得 EncString / EncJson →  
再传入业务函数。

前端不得自行构造 Enc 类型。

----------------------------------------
# 7. 与 UI 的交互约束
----------------------------------------
前端必须遵守：

- 所有展示前必须调用 DecryptForDisplay()  
- UI 内部不能缓存明文  
- 所有 Enc 类型必须由后端创建  
- 严禁使用普通 string 与 DLL/SO 直接通信  

----------------------------------------
# 8. DLL/SO 导出接口
----------------------------------------
EncInt    CreateEncInt(int value);
int       DecodeEncInt(EncInt v);

EncString CreateEncString(const char* raw);
void      DecodeEncString(EncString enc, char* out_buffer);

EncJson   CreateEncJsonFromRaw(const char* raw_json);
...

----------------------------------------
# 9. 示例代码
----------------------------------------
提供：
- C 示例  
- C++ 示例  
- Electron 绑定示例  
- Android JNI 示例  

----------------------------------------
# 10. 性能影响与优化
----------------------------------------
- 内存加密对 CPU 的额外消耗  
- 建议缓存解密结果在短生命周期内使用  
- 避免过度解密导致 UI 卡顿  

----------------------------------------
# 11. 安全注意事项
----------------------------------------
- 随机种子必须来源于高熵源  
- 内存恢复后的明文必须立即覆盖擦除  
- 不得在日志中打印明文  
- Enc 类型内存不可通过 memcpy 暴露  
